{% extends "base.html" %}
{% block title %}Доска задач{% endblock %}
{% block content %}
<div class="mx-auto w-full max-w-6xl py-10 px-2 min-h-screen">
  <h1 class="text-2xl font-bold text-blue-700 mb-8 text-center">
    {{ board.name }}
  </h1>
  <div>Владелец: {{ board.owner.full_name }} @{{ board.owner.username }}</div>
  <div class="mb-10">
      {% if board.owner_group %}
          <div class="flex items-center gap-4">
              <span class="text-gray-700">Группа {{ board.owner_group.name }}</span>
              <form method="post" action="{{ url_for('remove_board_from_group') }}" class="flex-shrink-0">
                  <input type="hidden" name="board_id" value="{{ board.id }}"/>
                  <button type="submit" class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700">Удалить доску из группы</button>
              </form>
          </div>
      {% else %}
          <div class="flex items-center gap-4">
              <span class="text-gray-700">Не принадлежит никакой группе</span>
              {% if available_groups %}
              <form method="post" action="{{ url_for('add_board_to_group') }}" class="flex items-center gap-2">
                  <input type="hidden" name="board_id" value="{{ board.id }}"/>
                  <select name="group_id" class="px-2 py-1 border rounded focus:outline-none focus:ring focus:ring-blue-300">
                      {% for g in available_groups %}
                          <option value="{{ g.id }}">{{ g.name }}</option>
                      {% endfor %}
                  </select>
                  <button type="submit" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700">Добавить доску в группу</button>
              </form>
              {% endif %}
          </div>
      {% endif %}
  </div>
  <div class="overflow-x-auto md:overflow-x-visible">
    <div class="flex flex-col md:flex-row gap-4 w-full">
      {% for status, title, color in [
        ("ideas", "Идеи", "bg-purple-100"),
        ("todo", "Нужно сделать", "bg-gray-100"),
        ("wip", "В работе", "bg-yellow-100"),
        ("done", "Готово", "bg-green-100")
      ] %}
      {% set status_cards = tasks | selectattr('status', 'equalto', status) | list %}
      <div class="flex-1 flex flex-col rounded-lg {{ color }} shadow-md min-w-60">
        <div class="font-semibold text-gray-700 px-4 py-3 border-b">{{ title }}</div>
        <div class="flex-1 overflow-y-auto px-4 py-2 space-y-3 column-cards" data-status="{{ status }}">
          {% for card in status_cards %}
          <a href="{{ url_for('card_detail', board_id=board.id, card_id=card.id) }}"
             class="rounded bg-white p-3 shadow hover:shadow-lg transition block" draggable="true" data-card-id="{{ card.id }}" data-card-status="{{ card.status }}">
            <div class="flex justify-between items-start gap-3">
              <div class="flex-1">
                <div class="font-medium text-base text-gray-800">{{ card.name }}</div>
                <div class="text-xs text-gray-500 mt-1">Создатель: {{ card.task_creator or "—" }}</div>
                <div class="text-xs text-gray-500">Исполнитель: {{ card.task_assignee or "—" }}</div>
                {% if card.task_description %}
                <p class="text-sm text-gray-600 mt-2 break-words">{{ card.task_description }}</p>
                {% endif %}
              </div>
              <div class="status-badge text-xs px-2 py-1 rounded whitespace-nowrap
              {% if status == 'done' %}bg-green-100 text-green-700{% elif status == 'wip' %}bg-yellow-100 text-yellow-700{% elif status == 'ideas' %}bg-purple-200 text-purple-700{% else %}bg-red-100 text-red-700{% endif %}">
                {{ card.status }}
              </div>
            </div>
          </a>
          {% endfor %}
          <div class="text-gray-400 text-sm empty-placeholder" {% if status_cards %}style="display:none"{% endif %}>
            Нет задач
          </div>
        </div>
        <form method="post" action="{{ url_for('board', board_id=board.id) }}" class="px-4 py-3 border-t flex flex-col gap-2">
          <input type="hidden" name="status" value="{{ status }}"/>
          <input type="text" name="name" required placeholder="Новая задача..." class="px-2 py-1 border rounded focus:outline-none focus:ring focus:ring-blue-300"/>
          <div class="flex flex-col gap-2">
            <input type="text" name="task_creator" value="{{ current_user.username }}" placeholder="Создатель" class="px-2 py-1 border rounded focus:outline-none focus:ring focus:ring-blue-300"/>
            <input type="text" name="task_assignee" placeholder="Исполнитель" class="px-2 py-1 border rounded focus:outline-none focus:ring focus:ring-blue-300"/>
          </div>
          <textarea name="task_description" rows="2" placeholder="Описание задачи" class="px-2 py-1 border rounded focus:outline-none focus:ring focus:ring-blue-300"></textarea>
          <button type="submit" class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">Добавить</button>
        </form>
      </div>
      {% endfor %}
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  function badgeClassesForStatus(status) {
    if (status === 'done') return ['bg-green-100','text-green-700'];
    if (status === 'wip') return ['bg-yellow-100','text-yellow-700'];
    if (status === 'ideas') return ['bg-purple-200','text-purple-700'];
    return ['bg-red-100','text-red-700'];
  }

  function updatePlaceholder(column) {
    const placeholder = column.querySelector('.empty-placeholder');
    if (!placeholder) {
      return;
    }
    const hasCards = column.querySelectorAll('[data-card-id]').length > 0;
    placeholder.style.display = hasCards ? 'none' : 'block';
  }

  function bindCard(card) {
    card.addEventListener('dragstart', function (e) {
      e.dataTransfer.setData('text/plain', card.dataset.cardId);
      card.classList.add('opacity-50');
    });
    card.addEventListener('dragend', function () {
      card.classList.remove('opacity-50');
    });
  }

  document.querySelectorAll('[draggable="true"]').forEach(bindCard);

  document.querySelectorAll('.column-cards').forEach(function (col) {
    updatePlaceholder(col);
    col.addEventListener('dragover', function (e) { e.preventDefault(); });
    col.addEventListener('drop', async function (e) {
      e.preventDefault();
      const cardId = e.dataTransfer.getData('text/plain');
      if (!cardId) return;
      const cardEl = document.querySelector('[data-card-id="' + cardId + '"]');
      if (!cardEl) return;
      const newStatus = col.dataset.status;
      const oldStatus = cardEl.dataset.cardStatus;
      if (newStatus === oldStatus) return;

      const sourceColumn = cardEl.closest('.column-cards');
      col.appendChild(cardEl);
      cardEl.dataset.cardStatus = newStatus;
      updatePlaceholder(col);
      if (sourceColumn && sourceColumn !== col) {
        updatePlaceholder(sourceColumn);
      }

      const badge = cardEl.querySelector('.status-badge');
      if (badge) {
        badge.textContent = newStatus;
        badge.className = 'status-badge text-xs px-2 py-1 rounded whitespace-nowrap';
        const extra = badgeClassesForStatus(newStatus);
        extra.forEach(c => badge.classList.add(c));
      }

      try {
        const res = await fetch('{{ url_for("move_card") }}', {
          method: 'POST',
          credentials: 'same-origin',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ card_id: cardId, new_status: newStatus })
        });
        if (!res.ok) {
          let data = {};
          try { data = await res.json(); } catch (e) {}
          alert('Не удалось изменить статус задачи: ' + (data.error || res.status));
          window.location.reload();
        }
      } catch (err) {
        alert('Ошибка сети при перемещении задачи');
        window.location.reload();
      }
    });
  });
});
</script>

{% endblock %}
